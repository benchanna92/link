<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat Bantuan Pembaikan Telefon</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background: #f5f7fa;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }
  .chatbox {
    width: 360px;
    max-width: 95vw;
    background: #20232a;
    color: #e1e4ea;
    border-radius: 16px;
    box-shadow: 0 12px 32px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    user-select: none;
    overflow: hidden;
    font-size: 14px;
    z-index: 1000;
  }
  .header {
    background: #24292e;
    padding: 16px;
    font-weight: 600;
    font-size: 18px;
    color: #61dafb;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .close-btn {
    background: transparent;
    border: none;
    color: #61dafb;
    font-size: 22px;
    cursor: pointer;
    padding: 0;
    user-select: none;
    transition: color 0.3s ease;
  }
  .close-btn:hover,
  .close-btn:focus {
    color: #21a1f1;
    outline: none;
  }
  .messages {
    background: #20232a;
    padding: 16px;
    flex-grow: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    scrollbar-width: thin;
    scrollbar-color: #61dafb transparent;
  }
  .messages::-webkit-scrollbar {
    width: 8px;
  }
  .messages::-webkit-scrollbar-thumb {
    background-color: #61dafb;
    border-radius: 4px;
  }
  .messages::-webkit-scrollbar-track {
    background: transparent;
  }
  .message {
    max-width: 80%;
    margin-bottom: 12px;
    padding: 12px 16px;
    border-radius: 16px;
    line-height: 1.4;
    word-wrap: break-word;
  }
  .message.user {
    background: #61dafb;
    color: #20232a;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
    box-shadow: 0 2px 6px rgba(97,218,251,0.5);
  }
  .message.gpt {
    background: #2d333b;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
    box-shadow: 0 2px 6px rgba(101,114,133,0.5);
  }
  .whatsapp-link {
    display: inline-block;
    margin: 12px auto 16px auto;
    padding: 10px 20px;
    background: #25D366;
    color: white;
    font-weight: 600;
    border-radius: 24px;
    cursor: pointer;
    text-decoration: none;
    user-select: none;
    font-size: 14px;
    box-shadow: 0 4px 6px rgb(37 211 102 / 0.5);
    transition: background-color 0.3s ease;
    max-width: 80%;
    text-align: center;
  }
  .whatsapp-link:hover,
  .whatsapp-link:focus {
    background-color: #1ebe57;
    outline: none;
  }
  .controls {
    display: flex;
    border-top: 1px solid #3c4048;
    background: #24292e;
    padding: 8px;
  }
  .controls input[type="text"] {
    flex-grow: 1;
    border: none;
    padding: 12px 16px;
    font-size: 14px;
    border-radius: 16px;
    color: #e1e4ea;
    background: #20232a;
  }
  .controls input[type="text"]::placeholder {
    color: #6b7280;
  }
  .controls input[type="text"]:focus {
    outline: none;
    background: #24292e;
  }
  .controls button {
    margin-left: 8px;
    background: #61dafb;
    border: none;
    color: #20232a;
    font-weight: 600;
    padding: 0 20px;
    font-size: 14px;
    cursor: pointer;
    border-radius: 16px;
    transition: background-color 0.3s ease;
  }
  .controls button:hover,
  .controls button:focus {
    background: #21a1f1;
    outline: none;
  }
  .finish-btn {
    margin: 0 auto 16px auto;
    background: #ff6b6b;
    border: none;
    color: white;
    font-weight: 700;
    padding: 12px 24px;
    font-size: 15px;
    border-radius: 24px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(255,107,107,0.6);
    transition: background-color 0.3s ease;
    user-select: none;
    display: none;
  }
  .finish-btn:hover,
  .finish-btn:focus {
    background: #e85c5c;
    outline: none;
  }
  @media (max-width: 420px) {
    .chatbox {
      width: 95vw;
    }
  }
</style>
</head>
<body>
  <section class="chatbox" role="region" aria-label="Pembantu Perbualan Pembaikan Telefon" aria-live="polite" aria-atomic="true">
    <header class="header">
      <h1 style="margin:0; font-size:1.25rem; color:#61dafb;">Pembantu Pembaikan Telefon</h1>
      <button class="close-btn" aria-label="Tutup Chatbox" title="Tutup Chatbox">&times;</button>
    </header>
    <div class="messages" id="messages" role="log" aria-live="polite" aria-relevant="additions"></div>
    <form class="controls" id="chatForm" aria-label="Borang mesej">
      <input type="text" id="inputField" autocomplete="off" placeholder="Taip mesej anda..." aria-required="true" aria-label="Ruangan input mesej" />
      <button type="submit" aria-label="Hantar mesej">Hantar</button>
    </form>
    <button class="finish-btn" id="finishBtn" aria-label="Tamatkan perbualan dan dapatkan kod kes">Tamatkan Perbualan</button>
  </section>

<script>
  (function(){
    const messagesEl = document.getElementById('messages');
    const form = document.getElementById('chatForm');
    const input = document.getElementById('inputField');
    const finishBtn = document.getElementById('finishBtn');
    const closeBtn = document.querySelector('.close-btn');
    const whatsappNumber = '60178040403';

    let userIssueMessages = []; // Simpan mesej pengguna sebagai isu semasa

    // Balasan simulasi GPT dalam Bahasa Melayu â€” balasan generik
    const gptSimulatedAnswers = [
      "Terima kasih atas maklumat itu. Boleh ceritakan lebih lanjut?",
      "Boleh saya tahu model telefon anda?",
      "Sudah cuba hidupkan semula telefon anda?",
      "Isu biasa, kami boleh membantu membaikinya dengan pantas.",
      "Apakah masa mula masalah ini berlaku?",
      "Teknisi kami pakar dalam masalah ini.",
      "Sila teruskan, ada apa-apa lagi?",
      "Boleh terangkan simptom masalah tersebut?",
      "Ada buat kemaskini baru-baru ini?",
      "Kami ingin pastikan telefon anda berfungsi sempurna."
    ];

    // Tambah mesej ke chat
    function appendMessage(text, sender='gpt') {
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('message');
      if(sender === 'user') {
        msgDiv.classList.add('user');
        msgDiv.textContent = text;
      } else if(sender === 'gpt') {
        msgDiv.classList.add('gpt');
        msgDiv.textContent = text;
      } else if(sender === 'system') {
        msgDiv.classList.add('gpt');
        msgDiv.style.fontStyle = 'italic';
        msgDiv.textContent = text;
      }
      messagesEl.appendChild(msgDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Jana kod kes 6 digit secara rawak
    function generateCaseCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // Buat pautan WhatsApp dengan mesej siap isi
    function createWhatsAppLink(caseCode, issueSummary) {
      const baseUrl = `https://wa.me/${whatsappNumber}`;
      const message = `Hai, saya telah selesai bersembang untuk pembaikan telefon. Kod kes saya ialah: ${caseCode}\nIsu yang dilaporkan: ${issueSummary}`;
      const url = `${baseUrl}?text=${encodeURIComponent(message)}`;
      const link = document.createElement('a');
      link.href = url;
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      link.className = 'whatsapp-link';
      link.textContent = 'Hantar Kod Kes ke WhatsApp';
      link.setAttribute('aria-label', 'Hantar kod kes ke WhatsApp');
      return link;
    }

    // Pilih balasan rawak dari simulasi
    function simulateGPTResponse() {
      const idx = Math.floor(Math.random() * gptSimulatedAnswers.length);
      return gptSimulatedAnswers[idx];
    }

    // Kawal input dan paparkan mesej
    function userSendsMessage(text) {
      userIssueMessages.push(text);
      appendMessage(text, 'user');
    }
    function gptSendsMessage(text) {
      appendMessage(text, 'gpt');
    }

    function setInputEnabled(enabled) {
      input.disabled = !enabled;
      form.querySelector('button[type=submit]').disabled = !enabled;
    }

    // Hantar mesej user
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = input.value.trim();
      if(!msg) return;
      userSendsMessage(msg);
      input.value = '';
      setInputEnabled(false);

      // Simulasi delay
      await new Promise(res => setTimeout(res, 900));

      const reply = simulateGPTResponse();
      gptSendsMessage(reply);

      setInputEnabled(true);
      input.focus();
      finishBtn.style.display = 'inline-block';
    });

    // Tamatkan perbualan, jana kod kes, hantar ke WhatsApp
    finishBtn.addEventListener('click', () => {
      if(finishBtn.disabled) return;
      finishBtn.disabled = true;
      setInputEnabled(false);
      gptSendsMessage("Terima kasih kerana bersembang. Saya akan menjana kod kes untuk anda...");
      setTimeout(() => {
        const caseCode = generateCaseCode();
        gptSendsMessage(`Kod kes unik anda ialah: ${caseCode}`);

        // Gabungkan mesej isu pengguna sebagai ringkasan (max 200 char)
        let issueSummary = userIssueMessages.join(" ");
        if(issueSummary.length > 200) {
          issueSummary = issueSummary.slice(0, 197) + '...';
        }

        // Tambah pautan WhatsApp
        const waLink = createWhatsAppLink(caseCode, issueSummary);
        messagesEl.appendChild(waLink);
        messagesEl.scrollTop = messagesEl.scrollHeight;

        finishBtn.style.display = 'none';
        finishBtn.disabled = false;
        setInputEnabled(false);
      }, 1500);
    });

    // Tutup chatbox
    closeBtn.addEventListener('click', () => {
      document.querySelector('.chatbox').style.display = 'none';
    });

    // Mesej sapaan awal dalam BM
    gptSendsMessage("Hai! Saya pembantu pembaikan telefon anda. Bagaimana saya boleh membantu?");
  })();
</script>
</body>
</html>
